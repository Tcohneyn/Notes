# 接受目标数据

------

### 1. 接收目标数据

- 介绍本视频关注点：接收从客户端发送到服务器的目标数据。
- 需要监听目标数据的广播事件（delegate broadcast）。

### 2. 获取并绑定目标数据委托

- 通过 Ability System Component 获取 `TargetDataSetDelegate`。
- 获取所需参数：
  - Ability Spec Handle（与任务关联的能力）。
  - Activation Prediction Key（激活预测键）。
- 创建回调函数 `OnTargetDataReplicatedCallback` 并绑定到 delegate。
- 支持 Lambda 或对象方法绑定。

### 3. 处理延迟接收的目标数据

- 若目标数据已发送且广播过，仍需调用回调函数。
- 使用 `CallReplicatedTargetDataDelegateIfSet` 检查并处理已接收数据。
- 设置等待远程玩家数据标志（`SetWaitingOnRemotePlayerData`）。

### 4. 回调函数行为

- 回调在服务器接收到复制目标数据时触发。
- 广播数据到能力任务，使执行引脚触发。
- 告知 Ability System Component 数据已接收并清除缓存（`ConsumeClientReplicatedTargetData`）。
- 确保只在必要时广播 delegate（`ShouldBroadcastAbilityTaskDelegates`）。

### 5. 测试目标数据接收

- 在编辑器中刷新节点，获取 hit result 并绘制调试球。
- 客户端点击目标，服务器同步显示目标位置。
- 确认客户端数据成功发送到服务器，实现客户端与服务器一致。

### 6. 使用目标数据前的关键步骤

- 必须在 Asset Manager 的 CPP 文件中调用：
  - `UAbilitySystemGlobals::Get()->InitGlobalData()` 初始化全局数据。
- 初始化包括 Target Data Script Struct Cache，否则会出现找不到结构体的错误。

### 7. 总结与成果

- 成功将客户端点击位置的目标数据发送到服务器。
- 确保服务器掌握目标数据位置，为下一步实现权威性技能（如发射火球）做准备。

------

