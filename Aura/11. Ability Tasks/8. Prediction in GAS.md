## 🎯《GAS预测机制详解》标题大纲

### 一、服务器权威与预测的必要性

- **服务器权威性**：多人游戏中，服务器应控制重要游戏状态变化。
- **问题**：若客户端可直接修改状态，易被作弊利用；若完全依赖服务器确认，则会产生输入延迟。
- **解决方案**：采用**预测（Prediction）**机制，让客户端提前执行操作并告知服务器。

------

### 二、预测机制的基本原理

- 客户端先行执行动作（移动、开门、攻击等），同时将操作信息发给服务器。
- 服务器验证操作有效性（例如是否穿墙、射击是否合理）。
- 若无效则**回滚（Undo）**客户端的变化。
- 快节奏多人游戏必须使用预测以保持流畅体验。

------

### 三、GAS（Gameplay Ability System）的预测目标

- 实现**自动化预测**：让能力逻辑和预测同步运作，而无需手动写出“if authority / else predicted”分支。
- 并非所有内容都需要预测：如脚步声无需预测，但伤害、生命、法力等需预测。

------

### 四、GAS 默认预测的内容

- 自动预测的系统包括：
  - **能力激活与触发事件**
  - **GameplayEffect 应用与属性修改**
  - **GameplayTag 修改**
  - **GameplayCue 事件（包括独立触发的 Cue）**
  - **Montage 与角色移动系统（UE 新系统支持）**
- 不预测的部分：
  - **效果移除（Effect Removal）**
  - **周期性效果（Periodic Effects）**

------

### 五、预测键（Prediction Key）的核心机制

- **定义**：每个预测行为都有唯一的 Prediction Key，用于标识与追踪。
- **工作流程**：
  1. 客户端执行预测动作并生成 Prediction Key。
  2. 将该 Key 发送至服务器。
  3. 服务器验证并回传结果（接受或拒绝）。
  4. 客户端根据反馈决定保留或回滚动作。
- 注意：这里“复制（Replication）”用于描述 Key 的往返传输，而非传统变量复制。

------

### 六、预测窗口（Prediction Window）

- 当客户端预测激活一个能力时，会开启一个短暂的**预测窗口**。
- 在该窗口中，客户端可进行重要游戏状态操作（如消耗属性值）而无需等待服务器确认。

------

### 七、能力激活与 Prediction Key 交互流程

1. 客户端调用 `TryActivateAbility()`：
   - 生成新的 Prediction Key。
   - 调用 RPC `ServerTryActivateAbility()`。
   - 不等待服务器，直接执行本地 `ActivateAbility()`。
2. 服务器收到 RPC：
   - 验证激活是否有效。
   - 调用 `ClientActivateAbilityFailed()` 或 `ClientActivateAbilitySucceeded()`。
3. 客户端收到响应：
   - 若失败：终止能力并回滚所有带该 Prediction Key 的副作用。
   - 若成功：保持现状，副作用有效。

------

### 八、预测副作用（Side Effects）

- **示例**：GameplayEffect、属性修改、标签修改、GameplayCue 等。
- 这些副作用不是“一级预测行为”，但会附带预测键以区分。
- 服务器与客户端各自持有该 Key 以同步状态。
- 当服务器复制回客户端时，客户端会检测是否已有相同 Key 的效果以避免重复执行。

------

### 九、效果同步与清理

- 客户端在本地容器中暂存预测的 GameplayEffect（可能暂时重复）。
- 当服务器回传 Prediction Key 后：
  - 客户端清除临时预测效果。
  - `OnRep_PredictionKey` 被调用以触发后续处理。

------

### 十、总结与进一步学习

- **核心理解**：预测机制确保客户端响应流畅，同时保留服务器权威。
- **深入阅读**：
  - `GameplayPrediction.h`（源码注释解释预测细节）
  - 包括属性预测与复杂预测同步逻辑。
- **实践意义**：理解 Prediction Key 后可完善自定义任务如 “TargetData Under Mouse”。

