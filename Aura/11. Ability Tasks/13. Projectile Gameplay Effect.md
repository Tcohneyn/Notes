# 抛射体游戏效果

------

### 1. 引言

- 欢迎回到教程
- 现有投射物已经可以正常显示，但击中敌人时没有效果
- 计划：通过 Gameplay Effect 改变属性（如生命值）

------

### 2. 创建基础伤害 Gameplay Effect

- 目标：创建一个能修改目标生命值的基础 Gameplay Effect
- 创建路径：Blueprints → Ability System → Gameplay Effects → 新建 Damage Gameplay Effect
- Blueprint 类型：Instant Gameplay Effect
- 添加 Modifier：影响 Health，数值为 -10（占位用）
- 保存并编译

------

### 3. 投射物携带 Gameplay Effect

- 在 AuraProjectile 的 Header 中增加 `FGameplayEffectSpecHandle DamageEffectSpecHandle`
- 设置 Blueprint 可读写，并允许在 Spawn Actor 时传入
- 引入 `GameplayEffectTypes.h`
- 投射物生成时：
  - 使用 Ability System Component 创建 Effect Spec Handle
  - 将 Spec Handle 设置到投射物的 `DamageEffectSpecHandle`

------

### 4. Ability 类中生成投射物

- 在 AuraProjectileSpell CPP 文件中：
  - 使用 `SpawnActorDeferred` 生成投射物
  - 在 Finish Spawning 前设置 DamageEffectSpecHandle
  - 创建 Spec Handle 的步骤：
    - 获取 Source ASC（Ability System Component）
    - 调用 `MakeOutgoingSpec` 传入 Damage Effect Class 与 Ability Level
    - 创建 Gameplay Effect Context
    - 返回 `FGameplayEffectSpecHandle` 并赋值给投射物

------

### 5. 投射物应用伤害

- 在 AuraProjectile 的 OnOverlap：
  - 检查服务器权限（Server Only）
  - 获取 Other Actor 的 Ability System Component
  - 如果有效，调用 `ApplyGameplayEffectSpecToSelf` 并传入投射物的 Spec Handle
  - 注意：
    - Spec Handle 需通过 `.Get()->` 访问内部数据

------

### 6. 调试与输出

- 通过 Attribute Set 的 Post Gameplay Effect Execute 打印日志
- 输出内容：
  - 目标角色名字
  - 当前 Health 值
- 确认伤害已应用

------

### 7. 初始化敌人属性

- 敌人默认属性未初始化
- 在 Enemy 类中调用 `InitializeDefaultAttributes`
- Blueprint 设置默认属性：
  - 使用 Aura 的 Primary、Secondary、Vital Attributes 作为占位
- 确保所有敌人类继承父类属性

------

### 8. 设置 Firebolt Damage Effect Class

- 在 Firebolt Ability Blueprint 中设置 Damage Effect Class → GDamage
- 编译保存

------

### 9. 多次伤害测试

- 发射多个投射物，延迟 0.5 秒后结束 Ability
- 观察敌人 Health 逐步下降（如 102.5 → 92.5 → 82.5 …）
- 客户端测试确认同步效果

------

### 10. 处理重叠重复伤害 Bug

- 问题：Fire Effect 重叠触发两次，导致伤害重复
- 原因：
  - 角色有多个组件生成重叠事件（Capsule + Mesh）
- 解决方案：
  - Capsule Component 设置 `GenerateOverlapEvents = false`
  - Mesh Component 保留重叠事件

------

### 11. 总结与后续

- Fireball 成功应用 Damage Gameplay Effect
- 当前实现：直接减少 Health（占位方案）
- 后续计划：
  - 使用 Meta Attributes，更精细化管理属性
  - 提供数据驱动的敌人属性初始化

------

