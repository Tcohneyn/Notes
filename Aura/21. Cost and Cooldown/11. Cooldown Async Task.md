这份视频教程主要讲解了如何在 C++ 中创建一个**异步任务（Async Task）**节点，用于监听技能冷却（Cooldown）的开始与结束，从而在 UI（Spell Globe）上实现冷却倒计时的可视化，避免在每一帧轮询检测冷却状态。

以下是详细的标题大纲式中文总结：

### 一、 目标与设计思路 [00:00 - 02:30]

- **可视化需求**：当技能进入冷却时，法术球（Spell Globe）图标需要变暗并显示剩余时间的倒计时 。

  

- **性能考量**：

  - 直接在 UI 的 `Tick` 函数中每一帧查询 Ability System Component (ASC) 的冷却状态是非常低效的 。
  - **解决方案**：创建一个异步任务节点（Async Task/Action），仅在冷却**开始**和**结束**时通知 UI，并在开始时一次性返回冷却总时长，由 UI 自己处理倒计时动画 。

- **类似案例**：这种机制类似于 GAS 自带的 `PlayMontageAndWait` 或之前创建的 `TargetDataUnderMouse`，利用委托（Delegate）作为蓝图中的执行引脚 。

  

### 二、 创建 C++ 异步任务类 [02:30 - 07:05]

- **类创建**：

  - 新建 C++ 类 `WaitCooldownChange`，继承自 `UBlueprintAsyncActionBase` 。

  - 存放路径：`AbilitySystem/AsyncTasks` 。

    

- **声明委托（Delegate）**：

  - 声明动态多播委托 `FCooldownChangeSignature`，参数为 `float TimeRemaining` 。

    

  - 在类中定义两个公有委托变量：`CooldownStart`（冷却开始）和 `CooldownEnd`（冷却结束），并标记为 `BlueprintAssignable`，这将成为蓝图节点的两个输出执行引脚 。

    

- **工厂函数**：

  - 创建静态函数 `WaitForCooldownChange`，用于实例化该任务 。

  - **输入参数**：需要 `UAbilitySystemComponent*`（用于监听）和 `FGameplayTag`（指定的冷却标签）。

  - 标记为 `BlueprintInternalUseOnly`，使其在蓝图中作为一个节点显示 。

    

### 三、 核心逻辑实现 [07:05 - 34:00]

- **成员变量**：在 Protected区域存储传入的 `ASC` 指针和 `CooldownTag` 。

- **监听冷却结束（Tag 移除）**：

  - 利用 `RegisterGameplayTagEvent` 监听指定冷却标签的变化 。

  - 回调函数 `CooldownTagChanged`：当标签计数（NewCount）变为 0 时，广播 `CooldownEnd` 。

    

- **监听冷却开始（GE 应用）**：

  - 利用 `OnActiveGameplayEffectAddedDelegateToSelf` 监听**具有持续时间**的 Gameplay Effect (GE) 的应用 。
  - 回调函数 `OnActiveEffectAdded`：
    - 检查应用进来的 GE 的 Asset Tags 或 Granted Tags 是否包含目标冷却标签 。
    - 如果匹配，说明冷却开始。

- **获取剩余时间**：

  - 使用 `ASC->GetActiveEffectsTimeRemaining()` 获取时间 。

  - 构建 `FGameplayEffectQuery`：使用 `MakeQuery_MatchAnyOwningTags` 创建查询，过滤器为仅包含目标冷却标签的容器 。

    

  - **处理多个效果**：该函数返回一个浮点数数组。通过循环算法找出数组中的**最大值**（Longest Time），作为最终的剩余时间并广播 `CooldownStart` 。

    

- **清理工作**：

  - 实现 `EndTask` 函数，调用 `RemoveAll` 移除委托绑定，并调用 `SetReadyToDestroy` 和 `MarkAsGarbage` 销毁任务对象 。

    

### 四、 蓝图集成与测试 [34:00 - 38:18]

- **蓝图调用**：

  - 在 `WBP_SpellGlobe` 的事件图表中，当 Widget Controller 设置完成后，调用 `WaitForCooldownChange` 节点 。

    

- **参数配置**：

  - 获取 `BP_OverlayWidgetController` 中的 ASC 传入节点 。

    

  - 暂时硬编码（Hardcode）冷却标签为 `Cooldown.Fire.Firebolt` 进行测试 。

    

- **测试验证**：

  - 连接 `Print String` 到 `CooldownStart` 和 `CooldownEnd` 引脚 。

  - 在编辑器中运行，施放火球术。

  - **结果**：立即打印 "Start"，并在冷却时间（如 3 秒）结束后打印 "End"，证明异步任务逻辑工作正常 。

    

### 五、 下一步计划 [38:18 - 38:18]

- 目前冷却标签是硬编码的，下一步需要让每个法术球（Spell Globe）知道自己应该监听哪个具体的冷却标签，并根据返回的时间更新 UI 视觉效果（阴影遮罩和数字倒计时）。

  