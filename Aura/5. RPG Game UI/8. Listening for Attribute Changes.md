# 使用 Delegate 实现属性变化响应与绑定回调

## 1. Widget Controller 的扩展功能

1.1 Widget Controller 已能广播初始值。
 1.2 通过 AuraAttributeSet 访问属性值（如 Health、MaxHealth）。
 1.3 需要处理属性 **变化时的响应**。

------

## 2. 绑定属性变化 Delegate

2.1 使用 AbilitySystemComponent 的 `GetGameplayAttributeValueChangeDelegate()` 获取指定属性的 Delegate。
 2.2 通过 AuraAttributeSet 提供的 `GetHealthAttribute()` / `GetMaxHealthAttribute()` 获取属性引用。
 2.3 Delegate 是 **Multicast Delegate**，非 Dynamic Multicast，所以使用 `AddUObject` 绑定。
 2.4 回调函数必须有特定签名：`const FOnAttributeChangeData& Data`。

------

## 3. 设计通用绑定函数

3.1 在基类 AuraWidgetController 中声明虚函数：`BindCallbacksToDependencies()`。
 3.2 子类 OverlayWidgetController 重写该函数，用于绑定具体属性变化回调。
 3.3 为每个属性变化声明回调函数：`HealthChanged(const FOnAttributeChangeData& Data)`、`MaxHealthChanged(const FOnAttributeChangeData& Data)`。

------

## 4. 回调函数实现与广播

4.1 在 `BindCallbacksToDependencies` 中：

- 获取 AttributeSet 并调用 `GetGameplayAttributeValueChangeDelegate()`。
- 使用 `AddUObject(this, &ClassName::HealthChanged)` 绑定函数。

4.2 在回调函数中使用 `Data.NewValue` 获取最新属性值。
 4.3 广播 WidgetController 内部的 Delegate（如 `OnHealthChanged.Broadcast(Data.NewValue)`）。

------

## 5. 调用绑定函数时机

5.1 在 HUD 中调用 `GetOverlayWidgetController()` 创建 Widget Controller 时。
 5.2 在设置好关键变量后立即调用 `BindCallbacksToDependencies()`。
 5.3 确保在 Widget Controller 初始化完成后，所有属性变化的回调已绑定。

------

## 6. 测试与效果验证

6.1 初始化属性：Health = 50，MaxHealth = 100 → 血条显示半满。
 6.2 拾取治疗药水 +25 → 血条更新至 75%。
 6.3 控制台命令 `ShowDebug AbilitySystem` 确认数值同步。

------

## 7. 依赖解耦设计

7.1 AbilitySystemComponent 与 OverlayWidgetController 相互独立。
 7.2 OverlayWidgetController 与具体的 Widget（如 HealthGlobe）独立，仅通过 Delegate 通信。
 7.3 实现 **单向依赖**，结构清晰、可扩展。

------

## 8. 总结

- 实现了 **属性变化 → Delegate → UI 更新** 的完整链路。
- 通过基类虚函数设计，保证所有 Widget Controller 都能方便绑定依赖。
- 解耦的设计使系统更强大、更灵活。

