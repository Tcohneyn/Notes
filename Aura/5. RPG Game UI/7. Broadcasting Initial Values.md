# 广播初始值

### **1. Widget Controller 与 Overlay Widget 的关系**

- Overlay Widget 持有对 Widget Controller 的引用（指针变量）。
- Widget Controller 本身**不依赖具体的 Widget**，它只知道有四个关键变量。
- 通过 **Delegates（委托）** 来广播数据，实现**单向依赖**：Widget Controller 不知道 Widget，Widget 可以接收 Controller 的广播。

------

### **2. 广播初始值**

- Widget Controller 需要广播初始值（如：初始生命值和法力值）。

- 在 **Base Widget Controller** 定义虚函数：

  ```cpp
  virtual void BroadcastInitialValues();
  ```

- 派生类（如 Overlay Widget Controller）重写：

  ```cpp
  virtual void BroadcastInitialValues() override;
  ```

------

### **3. 使用 Dynamic Multicast Delegate**

- 声明可以在 Blueprint 中绑定的动态多播委托：

  ```cpp
  DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnHealthChangedSignature, float, NewHealth);
  DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(FOnMaxHealthChangedSignature, float, NewMaxHealth);
  ```

- 成员变量：

  ```cpp
  UPROPERTY(BlueprintAssignable, Category="GAS|Attributes")
  FOnHealthChangedSignature OnHealthChanged;
  
  UPROPERTY(BlueprintAssignable, Category="GAS|Attributes")
  FOnMaxHealthChangedSignature OnMaxHealthChanged;
  ```

------

### **4. 获取真实属性值**

- 不直接广播固定值（如 100），而是从 Attribute Set 获取：

  ```cpp
  const UAuraAttributeSet* AuraAttrSet = CastChecked<UAuraAttributeSet>(AttributeSet);
  OnHealthChanged.Broadcast(AuraAttrSet->GetHealth());
  OnMaxHealthChanged.Broadcast(AuraAttrSet->GetMaxHealth());
  ```

- 确保 Attribute Set 已初始化后再调用 `BroadcastInitialValues()`。

------

### **5. 调用 BroadcastInitialValues**

- 在 Aura HUD 中 `InitOverlay()` 完成后：
  1. 创建 Widget 和 Widget Controller。
  2. 将 Widget Controller 设置到 Overlay Widget。
  3. 绑定 Widget 的事件到 Widget Controller 的 Delegates。
  4. 最后调用 `BroadcastInitialValues()`。

------

### **6. Blueprint 端绑定**

- Overlay Widget 可以有多个子 Widget（Health Globe、Mana Globe）共享同一 Widget Controller。
- 子 Widget Blueprint 中：
  1. 获取 Overlay Widget Controller。
  2. Cast 到 Blueprint 版本（BP_OverlayWidgetController）。
  3. 绑定事件（OnHealthChanged / OnMaxHealthChanged）更新 UI。

------

### **7. 设置 ProgressBar 百分比**

- 在 ProgressBar Base Class（WP_Globe_ProgressBar）添加函数：

  ```blueprint
  SetProgressBarPercent(float Percent)
  ```

- 在 Health Globe Blueprint 中：

  - 当 Health 或 MaxHealth 变化时，调用 `SetProgressBarPercent(Health / MaxHealth)`。
  - 使用 Safe Divide 防止除以 0。

------

### **8. 优化与组织**

- 将 BP Overlay Widget Controller 提升为变量，方便多处引用。
- Blueprint 可以直接操作这个变量，而不需要每次都 cast。

------

✅ **核心思路总结**

1. 使用 Widget Controller 统一管理数据。
2. 通过 Dynamic Multicast Delegate 广播变化，Widget Blueprint 绑定事件更新 UI。
3. BroadcastInitialValues 用于初始化所有 Widget 显示真实属性值。
4. Blueprint 与 C++ 协同，实现 UI 的实时更新和解耦。

------

如果你需要，我可以帮你画一张**Overlay Widget Controller 与子 Widget 之间数据流和事件绑定的流程图**，这样理解会更直观。

你希望我画吗？