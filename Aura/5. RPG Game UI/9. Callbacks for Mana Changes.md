# 使用 Delegate 扩展到 Mana 属性的变化响应

## 1. 挑战任务说明

1.1 任务目标：为 Mana（魔法值）实现和 Health 相同的回调绑定机制。
 1.2 步骤要求：

- 创建 Mana 与 MaxMana 的回调函数。
- 绑定这些回调函数到 AbilitySystemComponent 的属性变化 Delegate。
- 修改 EffectActor，使药水影响 Mana。
- 在 Blueprint 中完成 UI 的绑定。
   1.3 挑战特点：部分细节不直接说明，需要学员回忆和举一反三。

------

## 2. 在 OverlayWidgetController 中扩展 Mana 回调

2.1 声明函数：`ManaChanged(const FOnAttributeChangeData& Data)` 与 `MaxManaChanged(const FOnAttributeChangeData& Data)`。
 2.2 在头文件中新增 Delegate 类型：

- `OnManaChangedSignature(float NewMana)`
- `OnMaxManaChangedSignature(float NewMaxMana)`
   2.3 在 cpp 中实现回调：
- `OnManaChanged.Broadcast(Data.NewValue)`
- `OnMaxManaChanged.Broadcast(Data.NewValue)`

------

## 3. 绑定 Mana 属性变化

3.1 在 `BindCallbacksToDependencies()` 中：

- 获取 `GetManaAttribute()` 并绑定到 `ManaChanged()`。
- 获取 `GetMaxManaAttribute()` 并绑定到 `MaxManaChanged()`。
   3.2 工作流程：
- 属性变化 → ASC Delegate 触发 → WidgetController 回调 → 广播 UI Delegate → Widget Blueprint 响应。

------

## 4. 修改 EffectActor 影响 Mana

4.1 在设置 Health 的逻辑旁，增加 `SetMana(GetMana() - 25)`。
 4.2 这样拾取药水时会同时影响 Health 和 Mana。

------

## 5. 广播 Mana 初始值

5.1 在 `BroadcastInitialValues()` 中新增：

- `OnManaChanged.Broadcast(AuraAttributeSet->GetMana())`
- `OnMaxManaChanged.Broadcast(AuraAttributeSet->GetMaxMana())`
   5.2 确保 UI 启动时显示正确的 Mana。

------

## 6. 在 Blueprint 绑定 UI

6.1 打开 **ManaGlobe Widget Blueprint**。
 6.2 使用 `Event WidgetControllerSet`，获取并强制转换为 `BP_OverlayWidgetController`。
 6.3 绑定：

- `OnManaChanged → 更新变量 Mana`
- `OnMaxManaChanged → 更新变量 MaxMana`
   6.4 使用 `SetProgressBarPercent(Mana / MaxMana)` 更新进度条。

------

## 7. 测试与验证

7.1 初始值：Mana = 50 / Max = 50 → 显示满蓝条。
 7.2 拾取药水：Health ↑ 75%，Mana ↓ 25 → 蓝条减半。
 7.3 使用 `ShowDebug AbilitySystem` 验证数值同步。

------

## 8. 提示与总结

8.1 这是一次更大难度的挑战，需要完整回顾之前的实现思路。
 8.2 学会了为不同属性（Health / Mana）复用相同的回调绑定机制。
 8.3 系统已支持在 HUD 中实时显示 **生命值与魔法值** 的变化。
 8.4 可在多人游戏中验证，每个角色的属性变化均独立显示。

