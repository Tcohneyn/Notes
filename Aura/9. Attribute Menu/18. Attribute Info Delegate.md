## 🎯 Attribute Menu Widget Controller — 广播初始值与绑定流程

### 一、整体目标

- 在 Attribute Menu Widget Controller 中：
  - **绑定回调（callbacks）到依赖对象**
  - **广播初始属性值**给 UI
- 目的：让属性菜单（Attribute Menu Widget）正确显示当前角色属性。

------

### 二、AuraAttributeInfo 的结构与用途

- 在 Data Asset 中定义的 `FAuraAttributeInfo`：
  - 包含属性名称、描述、数值。
  - Widget 通过广播接收此结构体以更新自身显示。

------

### 三、获取属性集与属性值

1. 打开 `AttributeMenuWidgetController`

2. 获取 AttributeSet：

   ```cpp
   UAuraAttributeSet* AS = CastChecked<UAuraAttributeSet>(AttributeSet);
   ```

3. 从 AttributeSet 获取属性值（例如 Strength）：

   ```cpp
   AS->GetStrength();
   ```

------

### 四、定义动态多播代理（Delegate）

- 创建一个可广播 `FAuraAttributeInfo` 的代理：

  ```cpp
  DECLARE_DYNAMIC_MULTICAST_DELEGATE_OneParam(
      FAttributeInfoSignature, const FAuraAttributeInfo&, Info);
  ```

- 添加为成员变量：

  ```cpp
  UPROPERTY(BlueprintAssignable, Category="GAS|Attributes")
  FAttributeInfoSignature AttributeInfoDelegate;
  ```

- 用于广播属性信息，让多个 Widget 绑定接收。

------

### 五、准备 Data Asset 引用

- 添加成员变量：

  ```cpp
  UPROPERTY(EditDefaultsOnly)
  TObjectPtr<UAttributeInfo> AttributeInfo;
  ```

- 在蓝图中设定引用，以便通过 Tag 查找对应属性信息。

------

### 六、查找与填充属性信息

- 在 C++ 中查找数据：

  ```cpp
  const FAuraGameplayTags& Tags = FAuraGameplayTags::Get();
  FAuraAttributeInfo Info = AttributeInfo->FindAttributeInfoForTag(Tags.Attributes_Primary_Strength);
  ```

- 将实时属性值写入：

  ```cpp
  Info.AttributeValue = AS->GetStrength();
  ```

- 广播出去：

  ```cpp
  AttributeInfoDelegate.Broadcast(Info);
  ```

------

### 七、在蓝图中绑定与响应 Delegate

1. WidgetController Blueprint：
   - 设置 AttributeInfo 数据资产引用。
2. Widget（例如 TextValueButtonRow）：
   - 在 **Event Construct** 中：
     - 调用 `GetAttributeMenuWidgetController`
     - 执行 `Assign AttributeInfo Delegate`
     - 拆分（Break）Info 并读取内容。
3. 暂时仅打印属性名和数值进行验证。

------

### 八、父类 TextValueRow 的封装

- 父类 `TextValueRow` 中：

  - 提供 `TextBlock_Label`（属性名）和数值显示组件。

  - 新增函数：

    ```cpp
    void SetLabelText(FText LabelText)
    ```

- 子类 `TextValueButtonRow` 调用：

  ```cpp
  SetLabelText(Info.AttributeName);
  ```

------

### 九、蓝图连接与运行

1. 在 Widget Controller Blueprint：
   - 设定 Attribute Info 引用。
2. 在 Attribute Menu Widget：
   - 绑定 Delegate。
   - 确保在广播前完成绑定。
3. 修改 `BroadcastInitialValues()`：
   - 使其 BlueprintCallable。
   - 在 Widget Controller 设置完后调用。

------

### 十、运行与验证

- 编译并运行编辑器：
  - 若出现 `UAttributeInfo` 未声明错误 → 添加 forward declare。
  - 启动调试模式，检查 Delegate 是否成功广播。
  - 确认各 Widget 能接收到正确的属性信息并更新文本。

------

### 🧩 总结

本节实现了：

- **C++ → Blueprint → UI** 的属性数据传递。
- 使用 **Delegate 广播机制** 通知 UI。
- Blueprint 中 **自动绑定和显示属性名/数值** 的基础框架。

下节内容将继续完善：

- 每个属性行绑定对应的 GameplayTag。
- 当属性变化时自动更新 UI 显示。

