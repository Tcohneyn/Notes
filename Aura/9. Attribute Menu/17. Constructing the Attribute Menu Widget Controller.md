# Attribute Menu Widget Controller 制作教学总结（完整篇）

## 🎯 Quest 概要

**任务目标**：在 Unreal Engine 中构建 **Attribute Menu Widget Controller**，并通过 **Aura HUD** 与 Blueprint 完成数据交互，实现属性菜单的 UI 控制逻辑。

------

## 🧭 一、任务说明

- 本节任务目标：
  - 创建 Attribute Menu Widget Controller。
  - 为 AuraHUD 添加对应引用与访问接口。
  - 使 Blueprint 可调用并绑定该 Controller。
- 设计思路来源于 Overlay Widget Controller 的结构。

------

## 🧩 二、Aura HUD 结构复查与变量添加

### 现有变量

- `OverlayWidgetClass`（Widget 子类引用）
- `OverlayWidgetController`（实例引用）
- `OverlayWidgetControllerClass`（Controller 子类引用）

### 新增变量

- `TObjectPtr<UAttributeMenuWidgetController> AttributeMenuWidgetController`
- `TSubclassOf<UAttributeMenuWidgetController> AttributeMenuWidgetControllerClass`（Blueprint 可编辑）

> 小提示：`OverlayWidget` 可改为 private 检查是否引起报错。

------

## ⚙️ 三、创建 Getter 函数

### 函数签名

```cpp
UAttributeMenuWidgetController* AAuraHUD::GetAttributeMenuWidgetController(const FWidgetControllerParams& WCParams);
```

### 实现步骤

1. 判断是否已有实例：
    若 `AttributeMenuWidgetController == nullptr`：

   ```cpp
   AttributeMenuWidgetController = NewObject<UAttributeMenuWidgetController>(this, AttributeMenuWidgetControllerClass);
   ```

2. 调用：

   ```cpp
   AttributeMenuWidgetController->SetWidgetControllerParams(WCParams);
   AttributeMenuWidgetController->BindCallbacksToDependencies();
   ```

3. 返回 Controller。

> 与 Overlay Controller 逻辑相同，可去除冗余 return。

------

## 🧰 四、扩展 Blueprint Function Library

### 新增函数

- **名称**：`GetAttributeMenuWidgetController`
- **类型**：`Static Blueprint Pure`
- **输入**：`const UObject* WorldContextObject`
- **返回**：`UAttributeMenuWidgetController*`
- **分类**：`Widget Controller`

### 实现逻辑

1. 从 `WorldContextObject` 获取：
   - PlayerController
   - AuraHUD
   - PlayerState
   - AbilitySystemComponent (ASC)
   - AttributeSet
2. 构造 `FWidgetControllerParams` 参数。
3. 调用 AuraHUD 的 Getter 并返回结果。

------

## 🧪 五、在蓝图中测试调用

1. 打开 **Attribute Menu Widget Blueprint**。

2. 在 **Event Construct** 节点中调用：

   ```blueprint
   GetAttributeMenuWidgetController(Self)
   → SetWidgetController(返回值)
   ```

3. 若 Blueprint 无法识别类：

   - 在 C++ 类声明添加：

     ```cpp
     UCLASS(BlueprintType, Blueprintable)
     ```

   - 重新编译并创建 `BP_AttributeMenuWidgetController`。

------

## 🧱 六、在 HUD Blueprint 中设置引用

- 打开 **BP_AuraHUD**。
- 将 `AttributeMenuWidgetControllerClass` 指定为 `BP_AttributeMenuWidgetController`。

------

## 🧭 七、验证运行结果

- 在 **Attribute Menu Widget Blueprint** 的 `WidgetControllerSet` 事件中添加：

  ```blueprint
  PrintString(GetObjectName(WidgetController))
  ```

- 运行游戏，打开属性菜单。
   输出结果：

  ```
  AttributeMenuWidgetController
  ```

✅ 表示 Controller 成功初始化并绑定。

------

## 🧩 八、在 C++ 中绑定 UI 控制逻辑

### 创建 AttributeMenu 初始化函数

- 在 AuraHUD 中添加：

  ```cpp
  void InitAttributeMenu(APlayerController* PC, APlayerState* PS, UAbilitySystemComponent* ASC, UAttributeSet* AS);
  ```

- 函数逻辑：

  1. 检查 Widget Class 是否有效；
  2. 通过 `CreateWidget` 创建 Attribute Menu Widget；
  3. 调用 `GetAttributeMenuWidgetController`；
  4. 调用 `SetWidgetController()`；
  5. 调用 `AddToViewport()`。

> 与 Overlay 初始化函数基本一致。

------

## 🧱 九、在 PlayerController 中触发显示

- 在 `AAuraPlayerController` 中添加逻辑：
  - 按键事件触发 Attribute Menu 的显示。
  - 调用 AuraHUD 的 `InitAttributeMenu()`。

示例：

```cpp
if (AuraHUD)
{
    AuraHUD->InitAttributeMenu(PlayerController, PlayerState, ASC, AttributeSet);
}
```

------

## 🪟 十、Blueprint 层的显示控制

- 可在 UI 层设置：
  - 打开属性菜单：`AddToViewport()`
  - 关闭属性菜单：`RemoveFromParent()`
- 可添加 **布尔开关变量**（如 `bIsAttributeMenuVisible`）用于控制。

------

## 🧩 十一、完善交互与调试

- Blueprint 中添加调试输出确认：
  - Controller 是否绑定正确；
  - 属性是否同步；
  - 数据回调是否触发。
- 可以在 Controller 的 `BindCallbacksToDependencies()` 中添加更多委托绑定。

------

## 🧠 十二、总结与提升

### 本节收获

- 掌握 HUD 与 Widget Controller 的完整初始化流程。
- 理解 Attribute Menu 的独立控制结构。
- 学会通过 Blueprint Function Library 在蓝图中方便地获取 Controller。

### 设计思路

- Controller 持久存在，HUD 仅创建一次后复用。
- Blueprint 通过统一函数访问，保持模块化与解耦。
- 结构与 Overlay 系统一致，便于扩展与维护。

------

## ✅ 结语

至此，**Attribute Menu Widget Controller** 的创建与绑定流程全部完成。
 你现在拥有：

- AuraHUD 中的双控制器（Overlay + AttributeMenu）。
- 完整的 Blueprint 可访问接口。
- 稳定的 UI 控制与复用结构。

