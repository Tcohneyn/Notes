# **响应属性变化** 大纲（00:00:06 – 00:16:07）

## 1. 系统概览与初始广播

- 欢迎回到教程，当前系统运行良好。
- 已实现初始值广播：
  - 对主属性（Primary Attributes）进行广播。
  - 将 Gameplay Tags 映射到静态函数指针（Attribute Accessor）。
- 初始值在 Widget 构造时广播，Attribute Menu 会调用对应方法。

## 2. 动态更新属性值

- 需求：属性值变化时，更新 Widget 显示。
- 方法：
  - 使用回调函数（Callback）或 Lambda 表达式绑定到 Ability System Component 的 Delegate。
  - 通过 `GetGameplayAttributeValueChangeDelegate` 获取每个属性的变化 Delegate 并绑定。

## 3. 批量处理属性更新

- 使用 `for` 循环遍历 Tags → Attribute Accessor Map。
- 对每个属性：
  - 获取对应 Delegate。
  - 绑定 Lambda，实现变化时广播最新数值。
- Lambda 捕获：
  - 捕获 `pair`（Tag 与 Accessor）**按值**，避免循环局部变量超出作用域。

## 4. Lambda 内部逻辑

- 获取 `FAttributeInfo` 结构体，并填入最新属性值。
- 属性值来源：调用函数指针获取 Attribute，再读取数值。
- 最终广播 `FAttributeInfo` 到 Widget，实现界面更新。

## 5. 添加次要属性（Secondary Attributes）

- 初始 Map 只包含主属性。
- 扩展：将所有次要属性添加到 Tags → Accessor Map。
- 测试：
  - 打开 Attribute Menu，确认所有主次属性显示正确。

## 6. 属性变化测试

- 使用 Test Actor 应用 Test Effect 修改属性：
  - 修改 Strength：数值从 10 增加到 25，Attribute Menu 实时更新。
  - 修改 Resilience：相关派生属性 Armor 与 Armor Penetration 同步更新。
- 系统正确维护数学关系和依赖关系。

## 7. 优化代码复用

- 发现重复逻辑（获取 Attribute Info 并广播）。
- 创建私有函数 `BroadcastAttributeInfo(const FGameplayTag& AttributeTag, const FGameplayAttribute& Attribute)`：
  - 内部实现 Attribute Info 获取 + 广播。
  - 替换循环内重复代码，提高可维护性。
- Lambda 内无需再捕获 Attribute Set，可直接调用函数指针。

## 8. 总结

- 系统功能完整：
  - Attribute Menu 可以显示所有属性。
  - 数值变化实时更新。
  - 派生属性同步计算正确。
- 优势：
  - 可复用代码减少重复劳动。
  - 新增属性只需在 Map 中注册即可，无需修改 Widget Controller。
- 后续发展：
  - 实现属性点获取与消耗，用于升级属性。
  - 可进行视觉界面优化。

