## 从数据表中检索行（Retrieving Rows from Data Tables）

### 1. 找到数据表行并准备广播

- 成功根据给定的 Gameplay Tag 找到对应的数据表行。
- 希望能把这一行广播到 **Widget**，通过 **Delegate** 接收并在 HUD 上显示。
- 决定使用 **单一 Delegate** 来处理所有消息，因为数据表行本身包含完整信息：
  - Gameplay Tag
  - 消息文本
  - 图像或 Widget 等资源

------

### 2. 定义 Delegate

- 使用 **动态多播 Delegate（Dynamic Multicast Delegate）**，带一个参数：`FUIWidgetRow`。
- Delegate 签名命名为：
  - `FMessageWidgetRowSignature`
- 参数是 `FUIWidgetRow`，不是指针，需提前定义 `struct`。

------

### 3. 调整结构体定义

- 把 `FUIWidgetRow` 的定义提前到文件开头（包含区之后）。
- 发现依赖的 `UUserWidget` 类型未定义，使用 **Forward Declaration**。
- 编译成功，类型问题解决。

------

### 4. 在 Widget Controller 中声明成员变量

- 添加 `MessageWidgetRowDelegate` 成员变量。
- 使用 `UPROPERTY(BlueprintAssignable)`，使其可在 Blueprint 中绑定。
- 分类标签设为 `GAS|Messages`。

------

### 5. 广播 Delegate

- 在 Lambda 表达式中找到数据表行后，调用 `Broadcast`。
- 因为行是指针，需使用 `*Row` 解引用后传入。

------

### 6. 处理 Tag 限制

- 问题：并非所有 Asset Tags 都是消息标签。
- 解决：
  - 使用 **Gameplay Tag 匹配函数** `MatchesTag()`。
  - 通过 `FGameplayTag::RequestGameplayTag(FName("Message"))` 获取根消息标签。
  - 判断当前 Tag 是否是 Message 的子层级：
    - 例：`Message.HealthPotion` 匹配 `Message` → 返回 True。
    - `Message` 匹配 `Message.HealthPotion` → 返回 False。
- 这样就能确保只对 **消息类 Tag** 查表和广播。

------

### 7. 在 Overlay Widget Blueprint 中绑定事件

- 任务：在 **BP_Overlay** Widget 中接收数据表行并打印调试信息。
- 实现步骤：
  1. 获取并 **Cast** `WidgetController` 到 `BP_OverlayWidgetController`。
  2. 将其保存为变量。
  3. 在初始化序列中，绑定 `MessageWidgetRowDelegate`。
  4. 在响应事件中，拆解 `FUIWidgetRow`，打印调试字符串（Message 字段）。

------

### 8. 测试运行

- 编译并运行，拾取物品时输出消息：
  - “Picked up a Health Crystal”
  - “Picked up a Mana Potion”
  - “Picked up a Health Potion”
  - “Picked up a Mana Crystal”
- 系统成功根据 Gameplay Tag 找到对应的数据表行并广播。

------

### 9. 功能验证与扩展

- 当前获取到完整的 `FUIWidgetRow`，包含：
  - Tag
  - Message 文本
  - Widget Class
  - 图像资源
- 未来可扩展：
  - 设置 Widget 类
  - 使用图片资源
  - 显示更多自定义消息

