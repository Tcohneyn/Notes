# GAS 属性值限制（Clamp）深入解析与修正流程

------

### 1. 视频目标

- 深入理解 **Clamp（限制值）** 在 GAS（Gameplay Ability System）中的工作原理。
- 解决在预属性变化（Pre Attribute Change）中 clamp 不能永久生效的问题。

### 2. 当前实现回顾

- 已经在 **Health** 和 **Mana** 上应用了 Clamp。
- Pre Attribute Change 函数获取 **new value** 并进行 Clamp。
- new value 来源：
  - Gameplay Effect 的 Modifier （修改器）计算结果。
  - 直接设置属性也会调用此函数。

### 3. 测试问题演示

- 在拾取生命水晶时：
  - Health 能正确到达最大值（100）。
  - Clamp 限制正常。
- 进入火焰区域：
  - Health 未下降。
  - Debug 显示 Pre Attribute Change 的 new value 仍为 100（未生效）。

### 4. 问题原因分析

- Pre Attribute Change 的 Clamp **只影响返回值**，并不修改 Modifier 本身。
- 如果后续有其他 Gameplay Effect 查询该 Modifier（修改器），会重新计算值。
- 结果导致属性没有真正被永久限制。

**详细分析：**

1. **生成数值**：当 Gameplay Effect (GE) 被应用时（比如拾取水晶或受到火焰伤害），GE 中的 `Modifier`会**根据其配置（例如 Scalable Float 或 Attribute Based）计算出一个新的数值**。这个新值就是 `PreAttributeChange`函数里收到的 `NewValue`。
2. **“临时”限制（你遇到的问题）**：你在 `PreAttributeChange`中对这个 `NewValue`进行了 Clamp。**这步操作只影响了本次查询的返回值**，用于立即更新UI或进行临时计算，但**并没有改变底层 `Modifier`计算出的那个原始数值**。
3. **问题重现**：当后续有其他效果再次查询**同一个属性的 Modifier** 时（例如火焰伤害持续计算下一次扣血），系统会**重新用原始的 Modifier 规则进行计算**，得到的 `NewValue`可能再次超出你的限制范围，导致 Clamp 感觉“失效”。
4. **“永久”修正（你的解决方案）**：在 `PostGameplayEffectExecute`中（这通常只在 Instant 类型的 GE 对 BaseValue 进行**永久性**修改后触发），你使用 `SetHealth(FMath::Clamp(...))`**直接、永久地修改了 Attribute 的 BaseValue**。这样，任何后续的 Modifier 计算都会基于这个已被修正的基础值进行，限制效果也就永久生效了。

### 5. 解决方案：Post Gameplay Effect Execute

- 在 **Post Gameplay Effect Execute** 中判断属性类型：
  - `if (attribute == HealthAttribute)` 或 `ManaAttribute`。
- 使用 `FMath::Clamp` 实际 **设置 Health 或 Mana**。
- 优点：
  - 属性真正被限制。
  - 只产生一次网络同步，不重复复制。

### 6. 实际操作步骤

1. 在 Post Gameplay Effect Execute 中添加判断：
   - Health → `SetHealth(FMath::Clamp(GetHealth(), 0, GetMaxHealth()))`
   - Mana → `SetMana(FMath::Clamp(GetMana(), 0, GetMaxMana()))`
2. 移除 Pre Attribute Change 中的调试断点或 Onscreen Debug Message。
3. 运行调试模式，验证：
   - Health 与 Mana 超过最大值时被限制。
   - 进入火焰或受伤害时正确递减。

### 7. 总结要点

- Pre Attribute Change 仅对 **查询 Modifier（修改器） 的返回值** 有效。
- Post Gameplay Effect Execute 才能真正修改属性值。
- Clamp 应用顺序：
  1. Pre Attribute Change → 临时限制显示或计算。
  2. Post Gameplay Effect Execute → 真正修改属性值。
- 适用于 Health、Mana 等所有受 Gameplay Effect 修改的属性。