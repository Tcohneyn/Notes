# GAS 属性值限制（Clamp）深入解析与修正流程

------

### 1. 视频目标

- 深入理解 **Clamp（限制值）** 在 GAS（Gameplay Ability System）中的工作原理。
- 解决在预属性变化（Pre Attribute Change）中 clamp 不能永久生效的问题。

### 2. 当前实现回顾

- 已经在 **Health** 和 **Mana** 上应用了 Clamp。
- Pre Attribute Change 函数获取 **new value** 并进行 Clamp。
- new value 来源：
  - Gameplay Effect 的 Modifier 计算结果。
  - 直接设置属性也会调用此函数。

### 3. 测试问题演示

- 在拾取生命水晶时：
  - Health 能正确到达最大值（100）。
  - Clamp 限制正常。
- 进入火焰区域：
  - Health 未下降。
  - Debug 显示 Pre Attribute Change 的 new value 仍为 100（未生效）。

### 4. 问题原因分析

- Pre Attribute Change 的 Clamp **只影响返回值**，并不修改 Modifier 本身。
- 如果后续有其他 Gameplay Effect 查询该 Modifier，会重新计算值。
- 结果导致属性没有真正被永久限制。

### 5. 解决方案：Post Gameplay Effect Execute

- 在 **Post Gameplay Effect Execute** 中判断属性类型：
  - `if (attribute == HealthAttribute)` 或 `ManaAttribute`。
- 使用 `FMath::Clamp` 实际 **设置 Health 或 Mana**。
- 优点：
  - 属性真正被限制。
  - 只产生一次网络同步，不重复复制。

### 6. 实际操作步骤

1. 在 Post Gameplay Effect Execute 中添加判断：
   - Health → `SetHealth(FMath::Clamp(GetHealth(), 0, GetMaxHealth()))`
   - Mana → `SetMana(FMath::Clamp(GetMana(), 0, GetMaxMana()))`
2. 移除 Pre Attribute Change 中的调试断点或 Onscreen Debug Message。
3. 运行调试模式，验证：
   - Health 与 Mana 超过最大值时被限制。
   - 进入火焰或受伤害时正确递减。

### 7. 总结要点

- Pre Attribute Change 仅对 **查询 Modifier 的返回值** 有效。
- Post Gameplay Effect Execute 才能真正修改属性值。
- Clamp 应用顺序：
  1. Pre Attribute Change → 临时限制显示或计算。
  2. Post Gameplay Effect Execute → 真正修改属性值。
- 适用于 Health、Mana 等所有受 Gameplay Effect 修改的属性。