# 使用 DataTable 管理并广播 Gameplay Tags 信息

## 1. 回顾现状

- 我们已经能在拾取物品时 **获取到 Gameplay Effect 的 Asset Tags**。
- 例子：
  - **Mana Potion** → 含有两个 Gameplay Tags。
- 特点：
  - 这些 Tags **不会直接赋予角色**，而是附在 Gameplay Effect 上。
  - 我们在 **WidgetController** 里接收并使用这些 Tags。

------

## 2. Delegate 与 Lambda 绑定

- 在 `OverlayWidgetController` 中：
  - 将 **AbilitySystemComponent** 转换为 **AuraAbilitySystemComponent**。
  - 访问 `EffectAssetTags` Delegate。
  - 使用 **Lambda** 绑定匿名回调函数。
- Lambda 回调：
  - 参数：`const FGameplayTagContainer& AssetTags`。
  - 功能：遍历 AssetTags → 打印信息。
- 现状问题：
  - 目前只是 Debug 打印，还没有实质性的 UI 更新逻辑。

------

## 3. 扩展需求

- 希望通过 **Gameplay Tags 映射到更具体的信息**，传递给 Widgets。
- 示例：
  - **拾取血瓶** → 显示图标 + 文本 “Picked up Health Potion”。
  - 不仅仅是广播 Tag，还要 **查询并返回数据结构**。

------

## 4. 创建 DataTable 系统

### 4.1 定义 Row 结构体（C++）

- 位置：`OverlayWidgetController.h`。
- 结构体：`FUIWidgetRow`（继承 `FTableRowBase`）。
- 宏声明：`USTRUCT(BlueprintType)` + `GENERATED_BODY()`。
- 字段设计：
  1. **MessageTag**：`FGameplayTag`（初始化为空）。
  2. **Message**：`FText`，用于显示到屏幕。
  3. **MessageWidget**：`TSubclassOf<UAuraUserWidget>`，UI 控件类。
  4. **Image**：`UTexture2D*`（可选，显示图标）。
- 说明：可随时扩展更多字段（如数值 Magnitude 等）。

### 4.2 在编辑器中创建 DataTable

- 步骤：
  1. 新建文件夹：`Blueprints/UI/Data`。
  2. 右键 → **Miscellaneous → Data Table**。
  3. 选择 Row 结构体：`UIWidgetRow`。
  4. 命名：`DBT_MessageWidgetData`。
- 功能：
  - 每一行对应一个 **Gameplay Tag**，存储 UI 展示数据（文本、图标、Widget 等）。

------

## 5. 新增 Gameplay Tags（消息类）

- 位置：**Project Settings → Gameplay Tags**。
- 新建 Tags：
  - `Message.HealthPotion`
  - `Message.ManaPotion`
  - `Message.HealthCrystal`
  - `Message.ManaCrystal`
- 特点：统一以 `Message.` 为父标签，便于分类与查询。

------

## 6. WidgetController 与 DataTable 关联

- 在 `OverlayWidgetController` 中添加 DataTable 变量：

  ```cpp
  UPROPERTY(EditDefaultsOnly, BlueprintReadOnly, Category="WidgetData")
  UDataTable* MessageWidgetDataTable;
  ```

- 特点：

  - **EditDefaultsOnly** → 仅可在默认蓝图中设置。
  - **BlueprintReadOnly** → 可在蓝图 Event Graph 使用。

- 用途：

  - 在接收到 Gameplay Tag 时 → 查询 DataTable → 获取结构体信息 → 广播给 Widgets。

------

## 7. 工作流程总结

1. **拾取物品** → 应用 Gameplay Effect（含 Asset Tags）。
2. **AuraAbilitySystemComponent** → 触发 Delegate，传递 Asset Tags。
3. **WidgetController Lambda** → 接收到 Tags。
4. **查询 DataTable** → 通过 Tag 找到对应的文本、图标、Widget 等。
5. **广播 UI 信息** → Widgets 显示消息（如 “拾取了血瓶”）。

------

## 8. 下一步工作

- 在 C++ 中实现 **DataTable 查询与广播逻辑**。
- 将查询结果封装为数据结构，发送给 Overlay 或具体 Widgets。

