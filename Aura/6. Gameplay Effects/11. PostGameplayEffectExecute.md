# Unreal Engine 5 Attribute Set & Gameplay Effect 流程大纲

## 1. **引言**

- 回顾上节内容：创建 Instant Gameplay Effect 并应用。
- 本节目标：学习 Attribute Set 中 `pre attribute change` 与 `post gameplay effect execute` 的使用，以及如何收集源/目标数据。

------

## 2. **Pre Attribute Change**

### 2.1 功能

- 在属性被修改前调用。
- 用于**限制属性值范围（clamp）**。
- **不推荐在此执行复杂逻辑或触发其他效果**。

### 2.2 使用示例

- 假设有血量（Health）属性：
  - 可以在 `pre attribute change` 中：
    - 限制血量不超过最大值。
    - 防止属性被非法修改。
- 输入参数：
  - `FGameplayAttribute Attribute`
  - `float& NewValue`

------

## 3. **Post Gameplay Effect Execute**

### 3.1 功能

- 在 Gameplay Effect 对属性修改后调用。
- 可以获取详细的执行数据，用于：
  - UI 更新
  - 触发技能或状态
  - 打印日志/调试

### 3.2 参数来源

- 主要通过 `FGameplayEffectModCallbackData& data`：
  - `data.target` → 目标 AbilitySystemComponent
  - `data.source` → 源 AbilitySystemComponent（通过 Effect Context 获取）
  - `data.EvaluatedData.Attribute` → 被修改的属性
  - `data.EvaluatedData.Magnitude` → 属性修改值
- 可获取：
  - Avatar Actor（源/目标）
  - Controller（源/目标）
  - Character（源/目标）

### 3.3 使用示例

- 判断属性类型（如 Health）：
  - 输出 UI 日志。
  - 记录实际增减值（magnitude）。
- 获取源 Actor：
  - 通过 `data.EffectSpec.GetContext().GetOriginalInstigator()` 或 `GetEffectContext().GetSourceObject()`。
- 获取目标 Actor：
  - 直接从 `data.target` 获取 ASC，再通过 `GetAvatarActor()` 获取 Actor。

------

## 4. **数据收集与封装**

### 4.1 FEffectProperties Struct

- 结构体用于统一保存源/目标信息：
  - Source ASC / Target ASC
  - Source Avatar / Target Avatar
  - Source Controller / Target Controller
  - Source Character / Target Character
  - Effect Context Handle
- 优点：
  - 提高代码复用性
  - 减少重复逻辑
  - 后续可以直接传给 UI 或战斗逻辑

### 4.2 填充方法

- 在 `post gameplay effect execute` 中创建 struct 实例。
- 通过 Effect Context 和 data 参数填充所有字段。
- 确保指针有效（`IsValid()` 或 `nullptr` 判断）。

------

## 5. **调试与验证**

- 使用 `UE_LOG` 或断点检查：
  - 修改的属性类型
  - magnitude 数值
  - 源/目标 Actor 是否正确
- 建议：
  - 先测试简单属性（Health、Mana）
  - 确认数据收集流程正常，再扩展复杂逻辑

------

## 6. **最佳实践总结**

1. `pre attribute change` → 用于 **限制属性值**
2. `post gameplay effect execute` → 用于 **响应属性变化和触发逻辑**
3. 使用 struct 封装源/目标信息，提高可读性和可维护性
4. 调试重点：检查 data 中的属性、magnitude 以及源/目标指针
5. 避免在 `pre attribute change` 执行复杂逻辑，以免逻辑混乱

