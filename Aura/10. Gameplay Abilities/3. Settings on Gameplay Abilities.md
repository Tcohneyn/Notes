# 🎯 **Gameplay Ability Class 详解与设置总览**

------

## 一、概述

- 已建立第一个 Gameplay Ability（C++ 基类 + Blueprint 派生类）。
- 本节介绍 Ability Blueprint 中各项设置的作用与重点关注项。

------

## 二、标签系统（Tags）

### 1️⃣ Ability Tags

- 能力自身的标签。
- 用于标识能力类型，以便其他能力识别和交互。

### 2️⃣ Cancel Abilities With Tag

- 执行本能力时，**会取消拥有指定标签的能力**。
- 用于互斥或中断机制（如冲刺打断蓄力）。

### 3️⃣ Block Abilities With Tag

- 本能力激活期间，**阻止具有指定标签的能力**被激活。

### 4️⃣ Activation Owned Tags

- 激活期间**赋予角色的标签**。
- 可在 AbilitySystemGlobals 中设置为可复制。

### 5️⃣ Activation Required / Blocked Tags

- **Required**：需具备指定标签才可激活。
- **Blocked**：若具备指定标签则禁止激活（如被“眩晕”）。

### 6️⃣ Source / Target Tags

- **Source Required / Blocked Tags**：判断来源角色标签。
- **Target Required / Blocked Tags**：判断目标角色标签。

> 🧩 标签系统提供了一种简洁的条件与约束机制，控制能力激活逻辑。

------

## 三、输入与网络设置

### 1️⃣ Replicate Input Directly

- 将输入事件直接复制到服务器。
- ⚠️ 一般不建议启用（浪费带宽）。

### 2️⃣ Replication Policy

- 控制状态/事件的复制方式。
- 默认值即可，**不需修改**。

### 3️⃣ Instancing Policy

- 控制能力实例化方式：

| 模式                        | 说明                                                         | 性能 | 特点                                                         |
| --------------------------- | ------------------------------------------------------------ | ---- | ------------------------------------------------------------ |
| **Instanced Per Actor**     | 为每个技能创建一个**单一实例**，每次激活技能时都**重复使用**这个实例。 | 中等 | 优点：可以保存持久化数据（例如技能内部计时器、状态变量）。<br/>缺点：需要在每次激活后手动重置变量，防止旧数据影响下一次使用。独立 |
| **Instanced Per Execution** | 每次激活技能时都会**创建一个新的实例**。                     | 最低 | 优点：不同次激活间的数据完全隔离，无需手动清理。<br/>缺点：性能开销较大（因为频繁创建和销毁对象），且无法在不同次激活间保存状态。 |
| **Non-Instanced**           | **不创建任何实例**，直接使用技能的**类默认对象**。           | 最佳 | **优点**：**性能最佳**，没有实例化开销。<br/>**缺点**：**无法保存任何状态数据**，也无法绑定到Ability Tasks的委托上，功能受限。 |

------

## 四、网络执行策略（Net Execution Policy）

| 模式                 | 执行位置               | 特点                                                         |
| -------------------- | ---------------------- | ------------------------------------------------------------ |
| **Local Only**       | 仅客户端               | 仅在本地客户端运行​​，服务器完全不会执行该技能。​​<br/>适用场景​​：纯粹的客户端特效，如切换武器动画、UI音效等无需服务器验证的逻辑。 |
| **Local Predicted**  | 客户端 + 服务器        | 在本地客户端立即激活，然后发送请求到服务器执行。服务器会验证操作，并可以回滚无效的修改。<br/> 适用场景：需要快速响应且对正确性有要求的操作，如角色移动、技能释放。这是实现流畅游戏体验的关键策略。 |
| **Server Only**      | 仅服务器               | **仅在服务器上运行**，客户端不执行技能逻辑。<br/>**适用场景**：关键且必须由服务器权威判定的逻辑，如造成伤害、计算暴击、发放奖励等，防止客户端作弊。 |
| **Server Initiated** | 服务器触发后同步客户端 | 由**服务器首先运行**，然后将结果同步到所属的本地客户端上执行。<br/> **适用场景**：由服务器触发的效果，如BOSS对玩家施加的debuff、服务器端的环境伤害等。 |

> ✅ 一般能力使用 **Local Predicted**。

------

## 五、权限与同步设置

- ### 1️⃣ **Server Respects Remote Ability Cancellation**

  - **作用**：决定服务器是否信任客户端的“取消能力”请求。
  - **启用时（默认）**：
    - 客户端可主动取消能力；服务器将尊重并同步取消。
    - ⚠️ 存在作弊风险，客户端可能提前结束某些不利状态。
  - **关闭时（推荐）**：
    - 客户端请求会被忽略；取消由服务器统一决定。
    - 能力中应手动调用 `EndAbility()` 来结束。
  - ✅ **推荐做法**：保持客户端预测执行，但所有取消均由服务器端逻辑控制。

- ### 2️⃣ **Retrigger Instanced Ability**

  - 若勾选，允许重复激活正在运行的能力（会重置该实例）。
  - 若关闭，则必须等待上一次执行完全结束才能再次激活。
  - ⚠️ 对于带持续时间或循环逻辑的技能（如蓄力、吟唱），建议**关闭**。
  - ✅ 推荐：关闭（防止重入错误）。

- ### 3️⃣ **Net Security Policy**

  - 新增于 GAS 的网络安全层配置（UE5.3+）。
  - 控制客户端可否请求执行该能力：

  | 模式                         | 含义                                       |
  | ---------------------------- | ------------------------------------------ |
  | **Client Or Server**         | 双端可触发，默认模式。                     |
  | **Server Only**              | 仅服务器允许执行激活请求。                 |
  | **Server Only + Restricted** | 强制服务器验证，拒绝未经授权的客户端请求。 |

  - ✅ 推荐：**Server Only** 或 **Server Only + Restricted**
     用于 PVP 或联机对战时的安全保障。

  ------

  ### 4️⃣ **Net Execution Policy**

  - 决定该能力逻辑在哪一方执行。
  - 通常与上面 Net Security Policy 搭配理解：

  | Net Execution Policy | 安全策略搭配             | 执行模型              | 推荐场景      |
  | -------------------- | ------------------------ | --------------------- | ------------- |
  | Local Only           | 无安全校验               | 纯客户端表现          | 单机UI        |
  | Local Predicted      | Client or Server         | 预测执行 + 服务器校验 | ✅ 主动技能    |
  | Server Only          | Server Only              | 仅服务器执行          | 被动/自动触发 |
  | Server Initiated     | Server Only + Restricted | 服务器广播结果        | 特殊同步能力  |

------

## 六、能力资源系统

### 1️⃣ Cost（消耗）

- 用 **GameplayEffect** 实现。
- 定义消耗的属性（如法力、体力）及数值。

### 2️⃣ Cooldown（冷却）

- 同样通过 **GameplayEffect** 实现。
- 控制再次激活前的等待时间。
- 冷却开始时机由“提交冷却（Commit Cooldown）”决定。

------

## 七、触发机制（Ability Triggers）

- 可响应特定事件或标签变更自动触发能力。
- 触发类型：
  - Gameplay Event
  - Owned Tag Added
  - Owned Tag Present

------

## 八、性能与同步注意事项

- **Replication Policy 不需更改**（系统自动处理）。
- **Simulated Proxy 不会执行能力逻辑**，需通过 GameplayCue/Effect 实现视觉同步。
- **Server Respects Remote Cancellation** 建议关闭。
- **Replicate Input Directly** 建议关闭。

------

## 九、总结建议

| 项目                 | 建议设置                    |
| -------------------- | --------------------------- |
| Instancing Policy    | Instanced Per Actor（一般） |
| Net Execution Policy | Local Predicted             |
| Replication Policy   | 默认即可                    |
| Input Replication    | 关闭                        |
| Server Cancellation  | 关闭                        |

------

## 十、不建议使用的内容

1. **Replication Policy** 

   * **无用。不要使用它。** 有关Epic的官方解释，请参考Epic的“技能系统问答”。游戏技能**已经**默认从服务器复制到其所属的客户端了。注意：游戏技能**不会**在模拟代理上运行（对此应使用`GameplayEffects`和`GameplayCues`）。

2. **服务器遵循远程能力取消**

   * 这意味着当**本地客户端的技能结束时，服务器上的技能也会结束**。**通常不是一个好主意**；因为**服务器版本才是最重要的（权威版本）**。

3. **直接复制输入**

   - 总是将输入的按下/释放事件复制到服务器。

   - **Epic不鼓励使用此功能。**

   - **代码注释示例：**

     ```c++
     /** 直接输入状态复制。如果技能上的 bReplicateInputDirectly 设置为 true，则会调用这些函数，但这通常不是一件好事（相反，更推荐使用通用复制事件）。 */
     UAbilitySystemComponent::ServerSetInputPressed()
     ```

### **核心要点总结**

这张图列出了在Unreal引擎的Gameplay Ability System中应**避免使用**的三个功能，主要原因如下：

- **冗余或无效**：`Replication Policy`（复制策略）功能是多余的，因为系统已经默认处理了必要的复制。
- **破坏权威性**：`Server Respects Remote Ability Cancellation`（服务器遵循远程技能取消）让客户端影响了服务器的权威决策，这在网络游戏中是危险的设计，容易导致作弊或不同步。
- **效率低下且有更好替代方案**：`Replicate Input Directly`（直接复制输入）会带来不必要的网络流量，并且Epic官方推荐使用更高效的`Generic Replicated Events`（通用复制事件）来代替。
