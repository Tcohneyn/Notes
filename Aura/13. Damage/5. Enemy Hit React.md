# 敌人击中反应

### I. 🎯 目标与设计思路

- **当前状态与目标**：目前的伤害反馈仅表现为血条变化，缺乏视觉冲击力 。目标是实现敌人的受击反应（Hit React）。

- **核心机制**：

  - 使用 **Gameplay Ability (GA)** 来激活受击逻辑 。

  - 播放特定的受击蒙太奇（Montage）动画 。

  - 在受击动画播放期间，通过赋予标签来禁止敌人移动或攻击 。

    

- **标签系统**：使用 **Gameplay Effect (GE)** 向敌人应用一个 Gameplay Tag（游戏标签），以便在 C++ 中监听和响应状态变化 。

  

### II. ⚙️ 准备工作：标签与效果 (C++ & Editor)

- **创建 Gameplay Effect (GE)**：

  - 创建名为 `GE_HitReact` 的蓝图类 。

    

  - 将其持续时间策略（Duration Policy）设置为 **Infinite**（无限），以便后续手动移除 。

    

- **定义 Native Gameplay Tag**：

  - 在 C++ 中添加新的原生标签 `Effects.HitReact` 。

    

  - 编译并打开编辑器，将此标签添加到 `GE_HitReact` 的 **Granted Tags**（授予标签）列表中 。

    

### III. 💻 C++ 逻辑实现：监听与响应

- **监听标签变化**：

  - 在 `AuraEnemy` 类中，利用 `BeginPlay` 获取 Ability System Component (ASC) 。

    

  - 使用 `RegisterGameplayTagEvent` 绑定回调函数，监听 `Effects.HitReact` 标签 。

    

  - 设置事件类型为 `NewOrRemoved`，仅在标签首次添加或完全移除时触发 。

    

    

- **回调函数逻辑 (`HitReactTagChanged`)**：

  - 创建一个回调函数，接收标签和新计数（New Count）作为参数 。

  - **状态变量**：添加一个布尔变量 `bIsHitReacting`，当标签计数大于 0 时为 true，并将其暴露给蓝图 。

  - **移动控制**：

    - 添加 `BaseWalkSpeed` 变量存储基础移动速度 。

    - 当处于受击状态时，将 `CharacterMovement` 的 `MaxWalkSpeed` 设置为 0 。

    - 当受击结束（标签移除）时，将速度恢复为 `BaseWalkSpeed` 。

      

### IV. 🎬 游戏能力实现 (GA_HitReact)

- **创建能力**：创建名为 `GA_HitReact` 的 Gameplay Ability 。

- **应用效果**：

  - 使用 `ApplyGameplayEffectToOwner` 节点应用 `GE_HitReact` 。

    

  - 将返回的 Handle（句柄）提升为变量，以便后续移除效果 。

    

- 

  **播放动画**：使用 `PlayMontageAndWait` 任务节点播放受击动画 。

  

### V. 🔗 接口抽象化：获取受击蒙太奇



- **问题**：不同的敌人（如哥布林长矛手与投石手）需要播放不同的受击动画，不能硬编码 。

  

- **解决方案**：在 `CombatInterface` 中添加 `GetHitReactMontage` 函数 。

  

- **C++ 实现细节**：

  - 使用 `UFUNCTION(BlueprintNativeEvent, BlueprintCallable)` 修饰该函数，允许在 C++ 中提供默认实现并在蓝图中调用。

    

  - 在 `CharacterBase` 中添加 `HitReactMontage` 变量 。

    

  - 重写 `_Implementation` 版本，直接返回该变量 。

    

### VI. 🎨 蓝图配置与资源设置

- **完善 GA 逻辑**：

  - 在 `GA_HitReact` 中，获取 Avatar Actor 并转换为 `CombatInterface` 。

    

  - 调用 `GetHitReactMontage` 获取蒙太奇，并将其传入 `PlayMontageAndWait` 节点 。

    

- **动画资源配置**：

  - 为 Spear Goblin（长矛哥布林）和 Slingshot Goblin（投石哥布林）分别创建受击蒙太奇资源 。

    

  - 打开对应的敌人蓝图，设置 `HitReactMontage` 变量为各自的动画资源 。

    

### VII. ⏭️ 后续步骤

- 目前尚未处理蒙太奇播放结束后的逻辑（移除 GE）以及能力的激活 。

  

- 下一节课将处理移除 Gameplay Effect 和激活能力的具体实现 。

  

  