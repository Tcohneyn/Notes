好的，这是这段视频教程关于“UExecCalc_Damage 中伤害值设定和格挡实现”的详细大纲总结：

------



## I. 移除旧的伤害处理方式 (GE_Damage Modifiers Removal)



- **目的**: 将伤害数值的读取和处理权完全交给 Exec Calc。
- **操作**: 从 `GE_Damage` Gameplay Effect 中移除原有的 Modifier。
  - 原 Modifier 功能：修改 **Incoming Damage** Meta Attribute，其大小（Magnitude）通过 **Set by Caller Magnitude** (标签为 `Damage`) 获得。
- **结果**: `GE_Damage` 现在**只**使用 `ExecCalc_Damage` 进行计算。

------



## II. 在 Exec Calc 中读取 Set by Caller Magnitude



- **目标**: 在 `UExecCalc_Damage::Execute_Implementation` 中获取由调用者传入的原始伤害值。
- **实现步骤**:
  1. 声明一个 `float Damage` 变量用于存储伤害值。
  2. 调用 `Spec.GetSetByCallerMagnitude()`。
  3. 传入 `FAuraGameplayTags::Get().Damage` 标签。
  4. 如果找不到该值，默认返回 `0.f` 并发出警告（默认参数）。

------



## III. 使用 Exec Calc 输出伤害修改



- **目标**: 确保 Exec Calc 能够像原 Modifier 一样，将伤害值加到目标角色的 **Incoming Damage** Meta Attribute 上。
- **实现步骤**:
  1. 使用 `OutExecutionOutput.AddOutputModifier()` 函数。
  2. **修改属性**: 传入 `UAuraAttributeSet::GetIncomingDamageAttribute()`。
  3. **操作类型**: 传入 `EGameplayModOp::Additive` (相加)。
  4. **修改值**: 传入前面获取到的 `Damage` 变量。
- **测试结果**: 火球术依然能造成 **16** 点伤害，证明 Exec Calc 成功替代了 Modifier 的功能。

------



## IV. 实现目标角色的格挡 (Block Chance Implementation)



- **目标**: 捕获目标的 **Block Chance** 属性，并根据几率决定是否将伤害减半。



### A. 属性捕获设置（在构造函数中）



1. **定义捕获**: 在 `AuraDamageStatics` 结构体中定义 `BlockChanceDef`。
   - **属性**: `BlockChance`。
   - **来源**: `EGameplayEffectAttributeCaptureSource::Target`。
   - **快照**: `false`。
2. **添加关联**: 将 `BlockChanceDef` 添加到 `RelevantAttributesToCapture` 数组中。



### B. 在执行函数中计算格挡



1. **捕获 Block Chance**:
   - 声明 `float TargetBlockChance`。
   - 使用 `ExecutionParams.AttemptCalculateCapturedAttributeMagnitude()` 捕获 `BlockChance` 值。
   - **钳制 (Clamping)**: 确保 Block Chance 不小于 0：`TargetBlockChance = FMath::Max(0.f, TargetBlockChance)`。
2. **判定是否格挡 (Be Blocked)**:
   - 声明 `const bool bBlocked`。
   - 逻辑: 生成一个 1 到 100 之间的随机整数 (`FMath::RandRange(1, 100)`)，如果该随机数 **小于** `TargetBlockChance`，则判定格挡成功 (`bBlocked = true`)。
3. **应用伤害减半**:
   - 使用 **三元运算符** 修改伤害值。
   - `Damage = bBlocked ? Damage / 2.f : Damage;`



### C. 测试与验证



- **初始测试**: 攻击敌人，大部分伤害为 **16**，偶尔出现 **8** (格挡成功)，符合敌方角色较低的 Block Chance (4%)。
- **强制测试方法**:
  - **方法一（临时修改）**: 在 `GE_SecondaryAttributes_Enemy` 蓝图中，将 **Block Chance** 的 Modifier 类型从 `Attribute Based` 临时改为 `Scalable Float` 并设置为 **100**，此时伤害将**始终**为 **8**。
  - **方法二（推荐）**: 复制一个测试用的 `GE_SecondaryAttributes_Test` Gameplay Effect，修改其 Block Chance 为 100，然后在 **Character Class Info** Data Asset 中将敌人的二级属性改为使用此测试 GE，以便进行非破坏性测试。

------



## V. 总结与展望



- **里程碑**: 成功将复杂的战斗逻辑（如格挡几率判定）转移到 **Exec Calc** 中，这是 **RPG 战斗系统** 的核心。
- **后续**: 接下来将继续在 Exec Calc 中实现更多伤害计算逻辑，使战斗系统更加有趣和复杂。