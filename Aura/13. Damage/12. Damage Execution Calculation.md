# 12. **伤害执行计算**



### I. Exec Calc 类的创建与设置 (Class Creation and Setup)

------

- **目标**: 创建一个自定义执行计算类，用于处理复杂的伤害计算，替代原有的 Set by Caller Magnitude。
- **类类型**: 选择 **`UGameplayEffectExecutionCalculation`**。
- **文件路径**: 放置在 `AbilitySystem/ExecCalc/` 文件夹下。
- **类命名**: `UExecCalc_Damage` (使用 `ExecCalc_` 前缀作为惯例)。
- **在蓝图中关联**: 最终将 `GE_Damage` 的 Magnitude Calculation Type 设置为这个新的 Exec Calc 类。

------



### II. Exec Calc 的基础 C++ 结构 (Base C++ Structure)



------

- **构造函数**: 必须实现一个构造函数。
  - 示例：`UExecCalc_Damage();`
- **核心执行函数**: 必须覆盖 `UGameplayEffectExecutionCalculation` 的核心虚函数，该函数定义了实际的计算逻辑。
  - **函数签名**: `virtual void Execute_Implementation(const FGameplayEffectCustomExecutionParameters& ExecutionParams, FGameplayEffectCustomExecutionOutput& OutExecutionOutput) const override;`

------



### III. 在 `Execute_Implementation` 中获取数据 (Data Retrieval in Execute_Implementation)



------

为了进行计算，需要从输入参数 `ExecutionParams` 中获取关键信息：

- **1. 获取能力系统组件 (Ability System Components)**
  - **Source ASC**: `ExecutionParams.GetSourceAbilitySystemComponent()`
  - **Target ASC**: `ExecutionParams.GetTargetAbilitySystemComponent()`
- **2. 获取 Avatar Actors (施法者与目标 Actor)**
  - 使用三元运算符安全获取，以防 ASC 为空。
  - **Source Avatar**: `SourceASC ? SourceASC->GetAvatarActor() : nullptr`
  - **Target Avatar**: `TargetASC ? TargetASC->GetAvatarActor() : nullptr`
- **3. 获取效果规格 (Gameplay Effect Spec)**
  - **Effect Spec**: `ExecutionParams.GetOwningSpec()` (包含大量的效果信息)

------



### IV. 下一步计划 (Next Steps)



------

- **目标**: 最终目的是在 Exec Calc 中计算并设置 **Damage Meta Attribute** 的值。
- **接下来的任务**: 在下一个视频中，将学习如何在 Exec Calc 中**捕获**所需的属性（例如：伤害值、护甲值、抗性等）并使用它们进行计算。