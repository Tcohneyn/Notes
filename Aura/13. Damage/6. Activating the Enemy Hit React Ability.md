# 激活敌方受击反应能力

### I. 🎯 核心目标与逻辑回顾

- **回顾现状**：目前的 `GA_HitReact` 能力包含应用 Gameplay Effect (GE)、保存 Handle、获取蒙太奇并播放等逻辑，但尚未被激活 。

  

- **触发时机**：我们需要在属性集（Attribute Set）中，当敌人受到伤害且未死亡（非致命）时激活此能力 。

  

### II. 🛠️ 赋予敌人通用技能 (Granting Abilities)

- **数据资产扩展 (Data Asset Setup)**

  - 在 `CharacterClassInfo` 数据资产中，新增一个名为 `CommonAbilities` 的数组，类型为 `TArray<TSubclassOf<UGameplayAbility>>` 。

    

  - 这个数组用于存储所有敌人通用的技能（如受击反应）。

    

- **创建通用初始化函数 (Library Function)**

  - 在 `AuraAbilitySystemLibrary` 中创建静态函数 `GiveStartupAbilities` 。

    

  - **逻辑流程**：

    1. 获取 GameMode 和 `CharacterClassInfo` 。

       

    2. 遍历 `CommonAbilities` 数组 。

       

    3. 为每个技能创建 Spec，并调用 ASC 的 `GiveAbility` 赋予技能 。

       

       

- **在敌人中调用**

  - 在 `AuraEnemy::BeginPlay` 中调用此库函数，确保敌人出生时获得这些通用技能 。

    

    

### III. ⚡ 在属性集中激活技能 (Activating Ability)



- **激活逻辑 (C++ Implementation)**

  - 在 `AuraAttributeSet` 中，当伤害判定为非致命 (`!bFatal`) 时触发 。

    

  - 使用 `TryActivateAbilitiesByTag` 函数来通过标签激活技能，这是一种通用的激活方式 。

    

  - 创建一个 `FGameplayTagContainer`，向其中添加 `Effects.HitReact` 标签，并将其传入激活函数 。

    

- **蓝图配置 (Editor Setup)**

  - **配置数据资产**：在 `CharacterClassInfo` 的 `CommonAbilities` 中添加 `GA_HitReact` 。

    

  - **关键步骤**：为了让 `TryActivateAbilitiesByTag` 生效，必须在 `GA_HitReact` 蓝图的 **Class Defaults** 中，将 `Effects.HitReact` 添加到 **Ability Tags** 中 。

    



### IV. 🎨 动画调整与能力清理 (Polish & Cleanup)

- **动画混合调整**

  - 为了让受击反应更干脆，将蒙太奇（Montage）的 `Blend In` 和 `Blend Out` 时间缩短（例如 0.05秒） 。

    

    

- **实例化策略 (Instancing Policy)**

  - 将 `GA_HitReact` 的实例化策略更改为 **Instance Per Actor**，避免每次受击都创建新实例 。

    

- **结束能力逻辑 (Ending Logic)**

  - **移除效果**：使用之前保存的 Handle，调用 `RemoveGameplayEffectFromOwnerWithHandle` 移除那个让敌人定身的 GE 。

    

  - **触发节点**：在蒙太奇播放节点的 `OnCompleted`（完成）、`OnInterrupted`（被打断）和 `OnCancelled`（被取消）引脚上都连接此逻辑 。

    

  - **结束能力**：最后必须调用 `EndAbility` 节点，标志着能力运行结束 。

    

    

