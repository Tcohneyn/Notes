# UE5 自定义最大生命值和法力值计算类完整总结（中文标题大纲式）

## 1. 视频开场与目标

- 欢迎回到课程，说明本视频目标：
  - 创建自定义计算类（Custom Calculation Class）。
  - 实现最大生命值（Max Health）和最大法力值（Max Mana）不仅依赖其他属性，还能依赖其他非属性变量。
  - 修改 Gameplay Effect 并创建自定义计算类。

------

## 2. 创建自定义计算类（Custom Calculation Class）

### 2.1 新建 C++ 类

- 进入 C++ Classes → Aura → Public → AbilitySystem。
- 右键新建 C++ 类：
  - 选择 “All Classes”，找到 `GameplayModMagnitudeCalculation`。
  - 类命名为 `MSI_MaxHealth`，存放于 `ModMagCalc` 子文件夹（MSI = Modifier Magnitude Calculation）。
- 新类基于 `UGameplayModMagnitudeCalculation`。

### 2.2 文件准备与构造函数

- 打开新建的 `.h` 和 `.cpp` 文件。
- 声明并定义构造函数：
  - 公共区（public section）放构造函数声明。
  - 构造函数初始化属性捕获定义（Attribute Capture Definition）。

------

## 3. 自定义计算逻辑实现

### 3.1 重写计算函数

- 重写 `CalculateBaseMagnitude_Implementation`（virtual，返回 float）。
- 通过该函数计算 Modifier 的实际数值。
- 访问 Gameplay Effect Spec 获取相关信息。

### 3.2 捕获属性（Attribute Capture）

- 创建私有变量：
  - 类型：`FGameplayEffectAttributeCaptureDefinition`。
  - 示例：`FGameplayEffectAttributeCaptureDefinition VigorDef`。
- 在构造函数中配置捕获属性：
  - 指定捕获属性：`VigorDef.AttributeToCapture = UMyAttributeSet::GetVigorAttribute();`
  - 设置来源（Source 或 Target）：`VigorDef.AttributeSource = EGameplayEffectAttributeCaptureSource::Target;`
  - Snapshot 设置为 false（是否在创建时捕获属性值）。

### 3.3 将属性加入捕获数组

- 使用 `RelevantAttributesToCapture.Add(VigorDef)`。
- 保证 Modifier 在应用时能捕获目标属性的实际值。

------

## 4. 获取 Gameplay Tag

- 创建 `FGameplayTagContainer`：
  - `SourceTags` ← `Spec.CapturedSourceTags.GetAggregatedTags()`
  - `TargetTags` ← `Spec.CapturedTargetTags.GetAggregatedTags()`
- 可选：在计算逻辑中使用 Source 或 Target 的标签影响结果。

------

## 5. 评估属性数值

### 5.1 创建 Evaluation Parameters

- `FAggregatorEvaluateParameters EvaluationParameters`：
  - 设置 SourceTags 和 TargetTags。
- 用于从捕获的 Attribute Capture Definition 获取属性值。

### 5.2 获取属性 Magnitude

- 调用 `GetCapturedAttributeMagnitude`：
  - 输入：属性捕获定义、GameplayEffectSpec、EvaluationParameters。
  - 输出：float 值（如 `Vigor`）。
- 可选：使用 `FMath::Max(Vigor, 0.f)` 避免负值。

------

## 6. 计算 Modifier 最终数值

- 在 `CalculateBaseMagnitude_Implementation` 内使用捕获的属性值进行自定义计算。
- 可根据需要结合多个属性或外部变量计算最终 Modifier。
- 返回计算后的 float 作为 Modifier 的最终数值。

------

## 7. 调试与验证

- 可以在 Debug 模式下检查捕获的属性值是否正确。
- 验证最终的最大生命值或最大法力值是否符合预期。

------

## 8. 总结与注意事项

- 自定义计算类允许更灵活地计算属性值。
- 捕获属性和 Snapshot 设置影响数值获取时机。
- Gameplay Tags 可以扩展逻辑，实现更复杂的数值修改。
- 所有逻辑集中在 `CalculateBaseMagnitude_Implementation` 中，可根据需求扩展计算公式。

------

