# **UE5 GAS - Player Level 与 Combat Interface 的实现**

## 1. 引言

- 本视频目标：
  - 在 **PlayerState** 中添加 **Player Level**。
  - 创建并实现 **Combat Interface**，让角色与敌人统一获取等级。

------

## 2. 在 PlayerState 中添加 Level

- **变量定义**
  - 类型：`int32`
  - 默认值：`1`
  - 修饰符：`VisibleAnywhere`（便于蓝图可见）
  - 访问级别：`Private`（后续改为 Getter 访问）
- **网络同步**
  - Level 需要 **Replicated**（同步到客户端）。
  - 使用 **RepNotify**，在属性更新时触发广播。
- **关键函数**
  - `GetLifetimeReplicatedProps` → 注册属性复制。
  - `OnRep_Level(int32 OldLevel)` → 响应复制事件并广播。
- **宏使用**
  - `DOREPLIFETIME(AuraPlayerState, Level)` 标记变量复制。
  - 需要引入 `Net/UnrealNetwork.h`。



为了更全面地理解属性复制，以下表格总结了常用的复制宏及其用途：

| 宏名称                              | 作用描述                                                     | 适用场景                                                     |
| :---------------------------------- | :----------------------------------------------------------- | :----------------------------------------------------------- |
| **`DOREPLIFETIME`**                 | 注册属性，当**值发生变化时**将其从服务器同步到所有相关的客户端。 | 需要持续同步且变化频率不极高的属性，如玩家的等级、积分等。   |
| **`DOREPLIFETIME_CONDITION`**       | 在 `DOREPLIFETIME`基础上，增加**复制条件**，允许更精细地控制同步的目标。 | 需要优化网络流量时。例如，某些属性只需同步给所有者(`COND_OwnerOnly`)或模拟代理(`COND_SimulatedOnly`)。 |
| **`DOREPLIFETIME_ACTIVE_OVERRIDE`** | 允许在运行时根据**自定义条件**动态决定某个属性是否进行复制。 | 复制逻辑非常复杂，需要根据游戏状态动态判断的特殊情况。       |

------

## 3. 在 Enemy 中添加 Level

- **变量定义**
  - 类型：`int32`
  - 默认值：`1`
  - 修饰符：`EditAnywhere, BlueprintReadOnly`，分类为 "Character Class Defaults"
- **访问级别**
  - 最初设为 `Private`，但因 BlueprintReadOnly 不适用 → 改为 `Protected`。
- **复制逻辑**
  - **不复制**（只在服务端用于 AI 逻辑计算）。

------

## 4. Combat Interface 设计与实现

- **需求**

  - 角色（玩家/敌人）都有 `Level`，但位置不同：
    - 玩家 → PlayerState
    - 敌人 → 自身类（AuraEnemy）
  - 需要统一获取 `Level` 的接口。

- **Combat Interface**

  - 新建 `ICombatInterface`，存放在 `Interaction` 文件夹。

  - 定义函数：

    ```cpp
    virtual int32 GetPlayerLevel() const { return 0; }
    ```

  - 默认实现返回 `0`，避免强制实现。

------

## 5. 在角色类中实现接口

- **AuraCharacterBase**

  - 继承 `ICombatInterface`。

- **AuraEnemy**

  - 实现 `GetPlayerLevel()`，直接返回自身的 `Level`。

- **AuraCharacter**

  - 实现 `GetPlayerLevel()`：

    - 从 **PlayerState** 中获取等级。

    - 因 PlayerState 的 `Level` 是私有 → 添加公共 Getter：

      ```cpp
      FORCEINLINE int32 GetPlayerLevel() const { return Level; }
      ```

------

## 6. 命名冲突与调整

- 问题：UE Actor 类已有 `GetLevel()`。
- 解决：将函数改名为 **`GetPlayerLevel()`**。
  - Combat Interface → `GetPlayerLevel`
  - AuraEnemy → `GetPlayerLevel`
  - AuraCharacter → `GetPlayerLevel`
  - AuraPlayerState → `GetPlayerLevel` Getter

------

## 7. 优化与说明

- **ForceInline 使用**
  - 给 `GetPlayerLevel()` 添加 `FORCEINLINE`。
  - 优点：减少函数调用开销。
  - 说明：这是微优化，不会对性能造成明显差异。

------

## 8. 编译与调试

- **编译问题**
  - PlayerController 里 Enemy Interface 使用 `TObjectPtr` 出现报错。
  - 解决：改用 **Raw Pointer**。
- **结果**
  - 编译通过，功能实现。

------

## 9. 总结与展望

- 已完成：
  - PlayerState 和 Enemy 的 Level 系统。
  - Combat Interface 的实现 → 统一获取 Player Level。
- 下一步：
  - 在 **Custom Calculation Class（MMC）** 中使用 `GetPlayerLevel()` 参与属性计算。

